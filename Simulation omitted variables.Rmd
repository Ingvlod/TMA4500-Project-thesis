---
title: "Simulation omitted variables"
author: "Ingvild"
date: "2023-11-14"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lme4)
```

## Simulate underlying model

```{r}
n=2 #obs in cluster
m=5 #Cluster
sim=10
sim_id <- rep(1:sim, each = n*m)
cluster_id <- rep(rep(1:m, each = n), sim)
obs_id <- rep(as.factor(rep(1:n,m)), sim)
x=rnorm(n*m*sim, mean = 40, sd = 2)
a = rnorm(n*m*sim)+x
u <- rep(rnorm(m*sim, 0, 0.5), each=n)
e <- rnorm(n*m*sim, 0, 0.5)
y <- 5 + 0.25*x + 3*a + u + e
df <- data.frame(sim_id, cluster_id, obs_id, x, a, u, y)

```

```{r}

simulate_data_correlated_covariate <- function(sim, b0, b1, b2, n = 100, m = 10){
  sim_id <- rep(1:sim, each = n*m)
  cluster_id <- rep(rep(1:m, each = n), sim)
  obs_id <- rep(as.factor(rep(1:n,m)), sim)
  
  #fixed effects covariate
  x <- rnorm(n*m*sim, mean = 40, sd = 2)

  #make a correlated with x
  a <- rnorm(n*m*sim) + 0.5*x

  #random cluster-specific effect
  u <- rep(rnorm(m*sim, 0, 0.5), each = n)
  
  #random error
  e <-  rnorm(n*m*sim, 0, 0.5)

  y <- b0 + b1*x + b2*a + u + e

  #Create data frame
  df <- data.frame(sim_id, cluster_id, obs_id, x, a, u, y)
  return(df)
}
```

#Estimate model with omitted variables

```{r}
REmodel_estimate_betas_omitted <- function(sim, b0, b1, b2){
  beta0=c()
  beta1=c()
  df = simulate_data_correlated_covariate(sim, b0, b1, b2)
  for (i in 1:sim){
    REmodel_omitted = lmer(y~ x + (1|cluster_id), data = df[df$sim_id == i,])
    beta0=append(beta0,fixef(REmodel_omitted)[1])
    beta1=append(beta1,fixef(REmodel_omitted)[2])
  }
  return(list("b0"=beta0,"b1"=beta1))
}
```
```{r}
set.seed(222)
b0 = 12 
b1 = 0.25
b2 = 1
betas = REmodel_estimate_betas_omitted(1000, b0, b1, b2) 
#tar 4 in med 1000 simuleringer
```

```{r Fig1, echo=FALSE, fig.height=10, fig.width=15}
par(mfrow=c(2,2))
{hist(betas$b0, breaks=0.1*100, prob=TRUE, xlab="x", xlim=c(9,15),ylim=c(0,0.8),
      main=paste("Figure A.1:Histogram of estimated beta0"))
  abline(v=b0, col='red',lwd=2)
  legend("topright",c("True beta0"),fill=c("red"))}
{hist(betas$b1, breaks=0.1*100, prob=TRUE, xlab="x", xlim=c(0.2,1.5),ylim=c(0,30),
      main=paste("Figure A.1:Histogram of estimated beta1"))
  abline(v=b1, col='red',lwd=2)
  legend("topright",c("True beta1"),fill=c("red"))}
```
